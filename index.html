<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Hello</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css"
        integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.bundle.min.js"
        integrity="sha384-BOsAfwzjNJHrJ8cZidOg56tcQWfp6y72vEJ8xQ9w6Quywb24iOsW913URv1IS4GD"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<style>
    div#background,
    body {
        background-color: #f3f3f3;
        position: absolute;
        top: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
    }

    .light-border {
        border-color: #ddd;
    }

    #search-input {
        height: 64px;
        font-size: 1em;
    }

    .suggestion-item {
        transition: 100ms all;
        border-top: 1px solid transparent;
        border-bottom: 1px solid transparent;
    }

    .suggestion-item:hover {
        background: #fdfdfd;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
    }
</style>

<body>
    <div id="background"></div>

    <div id="container" class="d-flex flex-column mt-5 mb-5 ml-5 mr-5">
        <div id="search-box" class="d-flex flex-row bg-light p-3 align-items-center rounded shadow-sm">
            <h1 class="h3 mb-0">Indice de fragilité numérique</h1>

            <button id="search-button" class="ml-3 search-button btn btn-outline-secondary rounded dropdown-toggle"
                data-toggle="modal" data-target="#search-dropdown" aria-haspopup="true">
                Rechercher
            </button>

            <button id="print-page" class="btn btn-outline-secondary ml-3">
                Imprimer cette page
            </button>
        </div>

        <div id="results" class="mt-2">
            <div id="advice" class=" bg-light mt-3 rounded shadow-sm">
                <div id="scores-table" class="container row">
                    <div class="col-sm p-3">
                        <div class="lead">Accès à l'information</div>
                        <div class="text-muted"> Identifier des territoires mal couverts par une offre de service
                            d'information ou des populations qui auront des difficultés à comprendre l'information.
                        </div>
                    </div>
                    <div class="col-sm p-3">
                        <div class="lead">Accès aux interfaces numériques</div>
                        <div class="text-muted"> Identifier des territoires mal couverts par les réseaux ou dans
                            lesquels des populations auront des difficultés financières à y accéder. </div>
                    </div>
                    <div class="col-sm p-3">
                        <div class="lead">Compétences numériques</div>
                        <div class="text-muted"> Identifier des populations parmi lesquelles s'observe une fréquence
                            d'illectronisme ou difficulté à utiliser internet. </div>
                    </div>
                    <div class="col-sm p-3">
                        <div class="lead">Compétences administratives</div>
                        <div class="text-muted"> Identifier des populations parmi lesquelles s'observent des difficultés
                            à accomplir des procédures administratives.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="search-dropdown" class="modal fade">
        <div class="modal-dialog p-0 shadow">
            <div class="modal-content">
                <input id="search-input" type="text" class="form-control rounded-top"
                    placeholder="Rechercher le nom d'une commune ou son code postal">
                <div id="suggestions" class="">
                </div>
            </div>
        </div>
    </div>

    <!-- <div id="testdiv">
     
    </div> -->


    <div id="prototypes" class="d-none">
        <div id="suggestion-item-prototype" class="suggestion-item d-flex flex-row align-items-center p-3">
            <div class="flex-item">
                <h5 class="suggestion-item-commune-name mb-0"></h5>
            </div>
            <div class="flex-item ml-2">
                <div class="suggestion-item-post-code lean text-muted"></div>
            </div>
        </div>

        <div id="score-digits-prototype" class=" col-sm d-flex flex-column p-3">
            <div class="d-flex flex-row align-items-center">
                <div class="score-digits-value flex-item display-6"></div>
                <div class="score-digits-delta flex-item lead text-muted ml-2"></div>
            </div>
        </div>

        <div id="score-digits-no-delta-prototype" class="col-sm d-flex flex-column p-3">
            <div class="score-digits-value flex-item display-6">
            </div>
        </div>

        <div id="commune-report-prototype" class="p-0 bg-light mt-3 rounded shadow-sm">
            <div class="result-table-head p-3 d-flex flex-row align-items-center justify-content-between">
                <div class="flex-item d-flex flex-row align-items-center">
                    <div class="flex-item">
                        <h1 class="commune-name h3 mb-0"></h1>
                    </div>
                    <div class="commune-details ml-2 flex-item lead text-muted">
                    </div>
                </div>

                <div class="flex-item d-flex flex-row align-items-center">
                    <button class="close-button btn btn-outline-secondary">Fermer</button>
                </div>

            </div>

            <div class="scores-table container p-0">
                <div class="score-table-head row border-top">
                    <div class="head-column col-sm p-3 border-right">
                        <span class="lead text-muted">Score</span>
                    </div>
                    <div class="head-column-globale col-sm p-3 lead text-muted">
                        Score globale
                    </div>
                    <div class="head-column-accinformation col-sm p-3 lead text-muted">
                        Accès à l'information
                    </div>
                    <div class="head-column-accnumeriques col-sm p-3 lead text-muted">
                        Accès aux interfaces numériques
                    </div>
                    <div class="head-column-compadministratives col-sm p-3 lead text-muted">
                        Compétences administratives
                    </div>
                    <div class="head-column-compnumeriques col-sm p-3 lead text-muted">
                        Compétences numériques
                    </div>

                </div>
                <div class="score-row-commune row border-top">
                    <div class="commune-score-head-row col-sm p-3 border-right align-items-center">
                        <span class="lead">Moyenne de la commune</span>
                    </div>
                </div>
                <div class="score-row-departement row border-top">
                    <div class="col-sm p-3 border-right align-items-center">
                        <span class="lead">Moyenne du département</span>
                    </div>
                </div>
                <div class="score-row-region row border-top border-bottom">
                    <div id="region-score-head-row"
                        class="commune-score-item col-sm p-3 border-right align-items-center">
                        <span class="lead">Moyenne de la région</span>
                    </div>
                </div>
            </div>

            <div class="row p-3">
                <span class="blockquote text-muted mb-0">
                    Le score globale de cette commune est <span class="conclusion-departement">plus élevé</span> que
                    celui de son département et, est <span class="conclusion-region">moins élevé</span> que
                    sa région.
            </div>
        </div>
    </div>
    <script>
        const DOWN_TRIANGLE = "▼";
        const UP_TRIANGLE = "▲";
        const HIGHER_TEXT = "plus élevé";
        const lOWER_TEXT = "moins élevé";
        const HIGHER_CLASS = "text-success";
        const LOWER_CLASS = "text-danger";

        const suggestions = $('#suggestions');

        function getIdClone(id) {
            const clone = $(id).clone();
            clone.removeAttr('id');
            return clone;
        }

        function populateCommuneRowDOM(communeRow, statistics) {
            const {
                score_global,
                acces_information,
                acces_interface_numeriques,
                competences_administratives,
                competences_numeriques
            } = statistics;

            function cloneScoreDigitsDisplay() {
                return getIdClone('#score-digits-no-delta-prototype');
            }

            function setScoreDigitsText(scoreDigits, text) {
                scoreDigits.find('.score-digits-value').text(Math.round(text));
            }

            const cScoreGlobale = cloneScoreDigitsDisplay();
            const cAccesInformation = cloneScoreDigitsDisplay();
            const cAccesInterfaceNumeriques = cloneScoreDigitsDisplay();
            const cCompetenceAdministratives = cloneScoreDigitsDisplay();
            const cCompetenceNumeriques = cloneScoreDigitsDisplay();

            setScoreDigitsText(cScoreGlobale, score_global);
            setScoreDigitsText(cAccesInformation, acces_information);
            setScoreDigitsText(cAccesInterfaceNumeriques, acces_interface_numeriques);
            setScoreDigitsText(cCompetenceAdministratives, competences_administratives);
            setScoreDigitsText(cCompetenceNumeriques, competences_numeriques);

            [
                cScoreGlobale,
                cAccesInformation,
                cAccesInterfaceNumeriques,
                cCompetenceAdministratives,
                cCompetenceNumeriques
            ].forEach(cScoreDigit => {
                communeRow.append(cScoreDigit);
            });
        }

        function populateDeltaRowDOM(deltaRow, statistics, communeStatistics) {
            const {
                score_global,
                acces_information,
                acces_interface_numeriques,
                competences_administratives,
                competences_numeriques
            } = statistics;
            const {
                score_global: c_score_global,
                acces_information: c_acces_information,
                acces_interface_numeriques: c_acces_interface_numeriques,
                competences_administratives: c_competences_administratives,
                competences_numeriques: c_competences_numeriques
            } = communeStatistics;

            function cloneScoreDigitsDisplay() {
                return getIdClone('#score-digits-prototype');
            }

            function setScoreDigitsValue(scoreDigits, value, cValue) {
                const valueRounded = Math.round(value);
                const cValueRounded = Math.round(cValue);

                scoreDigits.find('.score-digits-value').text(valueRounded);

                const delta = valueRounded - cValueRounded;
                if (delta != 0) {
                    const marker = delta < 0 ? DOWN_TRIANGLE : UP_TRIANGLE;
                    const symbol = delta < 0 ? "-" : "+";
                    scoreDigits.find('.score-digits-delta').text(`${symbol}${Math.abs(delta)}${marker}`);
                }
            }

            const scoreGlobale = cloneScoreDigitsDisplay();
            const accesInformation = cloneScoreDigitsDisplay();
            const accesInterfaceNumeriques = cloneScoreDigitsDisplay();
            const competenceAdministratives = cloneScoreDigitsDisplay();
            const competenceNumeriques = cloneScoreDigitsDisplay();

            setScoreDigitsValue(scoreGlobale, score_global, c_score_global);
            setScoreDigitsValue(accesInformation, acces_information, c_acces_information);
            setScoreDigitsValue(accesInterfaceNumeriques, acces_interface_numeriques, c_acces_interface_numeriques);
            setScoreDigitsValue(competenceAdministratives, competences_administratives, c_competences_administratives);
            setScoreDigitsValue(competenceNumeriques, competences_numeriques, c_competences_numeriques);

            [
                scoreGlobale,
                accesInformation,
                accesInterfaceNumeriques,
                competenceAdministratives,
                competenceNumeriques
            ].forEach(scoreDigit => {
                deltaRow.append(scoreDigit);
            });
        }

        function onSuggestionItemClick(communeId) {
            const modal = new bootstrap.Modal(document.getElementById('search-dropdown'));
            modal.hide();

            $('#search-input').val('');
            suggestions.empty();

            fetch('/commune-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: communeId
                })
            })
                .then(data => data.json())
                .then(data => {
                    const copy = getIdClone('#commune-report-prototype');
                    copy.find('h1.commune-name').text(data.commune_name);
                    copy.find('.commune-details').text(`${data.postal_code} ${data.department_name}, ${data.region_name}`);

                    const { commune, departement, region } = data.statistics;

                    populateCommuneRowDOM(copy.find('.score-row-commune'), commune);
                    populateDeltaRowDOM(copy.find('.score-row-departement'), departement, commune);
                    populateDeltaRowDOM(copy.find('.score-row-region'), region, commune);

                    function getConclusionTextForDelta(delta) {
                        return deltaScoreGlobalDept < 0 ? lOWER_TEXT : HIGHER_TEXT;
                    }

                    function getSpanClassForDelta(delta) {
                        return delta < 0 ? LOWER_CLASS : HIGHER_CLASS;
                    }

                    const deltaScoreGlobalDept = Math.round(commune.score_global - departement.score_global);
                    const deltaScoreGlobalRegion = Math.round(commune.score_global - region.score_global);

                    const conclusionDepartment = copy.find('.conclusion-departement');
                    conclusionDepartment.text(getConclusionTextForDelta(deltaScoreGlobalDept));
                    conclusionDepartment.addClass(getSpanClassForDelta(deltaScoreGlobalDept));

                    const conclusionRegion = copy.find('.conclusion-region');
                    conclusionRegion.text(getConclusionTextForDelta(deltaScoreGlobalRegion));
                    conclusionRegion.addClass(getSpanClassForDelta(deltaScoreGlobalRegion));

                    copy.find('.close-button').click(() => {
                        copy.remove();
                    });

                    $('#results').prepend(copy);
                });
        }

        function fetchSuggestions(inputText) {
            fetch(`/search?query=${inputText}`)
                .then(data => data.json())
                .then(data => {
                    suggestions.empty();

                    data.map(({ _id, commune_name, postal_code }) => {
                        const copy = getIdClone("#suggestion-item-prototype");
                        copy.find('h5.suggestion-item-commune-name').text(commune_name);
                        copy.find('div.suggestion-item-post-code').text(postal_code);
                        suggestions.append(copy);
                        copy.click(() => onSuggestionItemClick(_id));
                    });
                });
        }

        $(() => {
            $('#search-input').on('input', () => {
                const inputText = $('#search-input').val();
                fetchSuggestions(inputText);
            });
        });



    </script>
</body>

</html>